name: Check Tailscale Version

on:
  schedule:
    # Run daily at 8 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force check for new version even if one exists'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-tailscale-version:
    runs-on: ubuntu-latest
    name: Check Tailscale Version
    
    outputs:
      new_version: ${{ steps.compare.outputs.new_version }}
      version_changed: ${{ steps.compare.outputs.version_changed }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch latest Tailscale version from GitHub
      id: fetch_latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Fetching latest Tailscale version from GitHub API..."
        
        # Get latest release from tailscale/tailscale
        RESPONSE=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/tailscale/tailscale/releases/latest")
        
        if [ -z "$RESPONSE" ]; then
          echo "ERROR: Failed to fetch Tailscale releases"
          exit 1
        fi
        
        # Extract version from response
        LATEST_VERSION=$(echo "$RESPONSE" | grep -oP '"tag_name":\s*"\K[^"]+' | head -1)
        
        if [ -z "$LATEST_VERSION" ]; then
          echo "ERROR: Could not extract version from GitHub API response"
          echo "Response: $RESPONSE"
          exit 1
        fi
        
        # Remove 'v' prefix if present
        LATEST_VERSION=${LATEST_VERSION#v}
        
        echo "Latest Tailscale version found: $LATEST_VERSION"
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "raw_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "tag_version=v$LATEST_VERSION" >> $GITHUB_OUTPUT

    - name: Get latest GitHub release for Tailscale
      id: get_release
      uses: actions/github-script@v7
      with:
        script: |
          // Get all releases and find the latest Tailscale release
          const { owner, repo } = context.repo;
          
          const releases = await github.rest.repos.listReleases({
            owner: owner,
            repo: repo,
            per_page: 100
          });
          
          // Find the latest release tagged as tailscale-v*
          const tailscaleReleases = releases.data.filter(release => 
            release.tag_name && release.tag_name.match(/^tailscale-v[0-9]+\.[0-9]+\.[0-9]+$/)
          );
          
          if (tailscaleReleases.length === 0) {
            console.log('No existing Tailscale releases found');
            return null;
          }
          
          // Sort by tag name (semantic version)
          tailscaleReleases.sort((a, b) => {
            const versionA = a.tag_name.replace('tailscale-v', '');
            const versionB = b.tag_name.replace('tailscale-v', '');
            const partsA = versionA.split('.').map(Number);
            const partsB = versionB.split('.').map(Number);
            
            for (let i = 0; i < Math.max(partsA.length, partsB.length); i++) {
              const partA = partsA[i] || 0;
              const partB = partsB[i] || 0;
              if (partA !== partB) {
                return partB - partA; // Return highest version first
              }
            }
            return 0;
          });
          
          const latestRelease = tailscaleReleases[0];
          console.log(`Latest Tailscale release: ${latestRelease.tag_name} (${latestRelease.name})`);
          
          // Extract version number from tag
          const version = latestRelease.tag_name.replace('tailscale-v', '');
          core.setOutput('current_version', version);
          core.setOutput('release_tag', latestRelease.tag_name);
          core.setOutput('release_id', latestRelease.id.toString());

    - name: Compare versions
      id: compare
      run: |
        LATEST_VERSION="${{ steps.fetch_latest.outputs.latest_version }}"
        CURRENT_VERSION="${{ steps.get_release.outputs.current_version }}"
        
        echo "Latest version from GitHub: $LATEST_VERSION"
        echo "Current version in releases: $CURRENT_VERSION"
        
        # Function to compare versions
        version_compare() {
          echo "$1" | awk -F. '{ printf("%d%03d%03d%03d\n", $1,$2,$3,$4); }'
        }
        
        LATEST_NUM=$(version_compare "$LATEST_VERSION")
        CURRENT_NUM=$(version_compare "$CURRENT_VERSION")
        
        echo "Latest version number: $LATEST_NUM"
        echo "Current version number: $CURRENT_NUM"
        
        if [ -z "$CURRENT_VERSION" ] || [ "$LATEST_NUM" -gt "$CURRENT_NUM" ]; then
          echo "âœ… New version detected: $LATEST_VERSION"
          echo "version_changed=true" >> $GITHUB_OUTPUT
          echo "new_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        else
          echo "âœ… No new version. Latest: $LATEST_VERSION, Current: $CURRENT_VERSION"
          echo "version_changed=false" >> $GITHUB_OUTPUT
          echo "new_version=" >> $GITHUB_OUTPUT
        fi

    - name: Get release changelog
      if: steps.compare.outputs.version_changed == 'true' || github.event.inputs.force_check == 'true'
      id: get_changelog
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ "${{ steps.compare.outputs.version_changed }}" == "true" ] || [ "${{ github.event.inputs.force_check }}" == "true" ]; then
          echo "Fetching changelog for version ${{ steps.fetch_latest.outputs.tag_version }}"
          
          # Get release details from GitHub API
          RESPONSE=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/tailscale/tailscale/releases/tags/${{ steps.fetch_latest.outputs.tag_version }}")
          
          if [ -z "$RESPONSE" ]; then
            echo "WARNING: Could not fetch changelog"
            echo "changelog=" >> $GITHUB_OUTPUT
          else
            # Extract body (changelog) from response
            CHANGELOG=$(echo "$RESPONSE" | grep -oP '"body":\s*"\K[^"]+' | head -1)
            # Escape newlines for GitHub Actions
            CHANGELOG=$(echo "$CHANGELOG" | sed 's/\\n/ /g' | sed 's/"/"/g' | sed 's/\\r//g')
            echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Trigger build workflow if new version
      if: steps.compare.outputs.version_changed == 'true' || github.event.inputs.force_check == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const newVersion = '${{ steps.compare.outputs.new_version }}';
          const changelog = '${{ steps.get_changelog.outputs.changelog }}';
          
          console.log(`Triggering build workflow for Tailscale ${newVersion}`);
          
          // Trigger the build-and-release workflow
          await github.rest.actions.createWorkflowDispatch({
            owner: owner,
            repo: repo,
            workflow_id: 'build-and-release.yml',
            ref: 'main',
            inputs: {
              package: 'tailscale',
              new_version: newVersion,
              changelog: changelog || 'Changelog not available'
            }
          });

    - name: Report status
      run: |
        if [ "${{ steps.compare.outputs.version_changed }}" == "true" ] || [ "${{ github.event.inputs.force_check }}" == "true" ]; then
          echo "ðŸš€ New Tailscale version detected: ${{ steps.compare.outputs.new_version }}"
          echo "âœ… Build workflow triggered successfully"
        else
          echo "âœ… No new Tailscale version found"
          echo "ðŸ“Š Latest: ${{ steps.fetch_latest.outputs.latest_version }} | Current: ${{ steps.get_release.outputs.current_version }}"
        fi