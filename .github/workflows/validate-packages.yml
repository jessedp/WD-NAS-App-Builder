name: Validate Packages

on:
  push:
    paths:
      - 'apps/**/apkg.rc'
      - 'apps/**/icon*'
      - 'apps/**/logo.*'
      - 'apps/**/index.php'
  pull_request:
    paths:
      - 'apps/**/apkg.rc'
      - 'apps/**/icon*'
      - 'apps/**/logo.*'
      - 'apps/**/index.php'
  workflow_dispatch:

jobs:
  validate-packages:
    runs-on: ubuntu-latest
    name: Validate Package Files
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch latest main branch
      run: |
        git fetch origin main --no-tags --prune --depth=1 || git fetch origin main --no-tags --prune

    - name: Install required packages
      run: |
        sudo apt-get update
        sudo apt-get install -y file

    - name: Run package validation
      id: validate
      shell: bash
      run: |
        set -euo pipefail

        TEMPLATE_RC="apps/template/apkg.rc"
        if [[ ! -f "$TEMPLATE_RC" ]]; then
          echo "ERROR: Could not read template apkg.rc at $TEMPLATE_RC" >&2
          exit 1
        fi

        trim() {
          local s="$1"
          s="${s#${s%%[![:space:]]*}}"
          s="${s%${s##*[![:space:]]}}"
          printf '%s' "$s"
        }

        get_rc_value() {
          local file="$1"
          local key="$2"

          local line
          line="$(grep -m1 -E "^${key}:" "$file" 2>/dev/null || true)"
          line="${line#*:}"
          trim "$line"
        }

        json_escape() {
          local s="$1"
          s="${s//\\/\\\\}"
          s="${s//\"/\\\"}"
          s="${s//$'\n'/\\n}"
          s="${s//$'\r'/\\r}"
          s="${s//$'\t'/\\t}"
          printf '%s' "$s"
        }

        find_icon() {
          local app_dir="$1"
          local icon="$2"

          local icon_base="${icon%.*}"
          local search_name

          for dir in "$app_dir/web" "$app_dir"; do
            if [[ -n "$icon" && -f "$dir/$icon" ]]; then
              printf '%s' "$dir/$icon"
              return 0
            fi

            if [[ -n "$icon_base" ]]; then
              for ext in png svg jpg jpeg; do
                search_name="$icon_base.$ext"
                if [[ -f "$dir/$search_name" ]]; then
                  printf '%s' "$dir/$search_name"
                  return 0
                fi
              done

              if [[ -f "$dir/$icon_base" ]]; then
                printf '%s' "$dir/$icon_base"
                return 0
              fi
            fi
          done

          return 1
        }

        validate_icon_file() {
          local icon_path="$1"

          if [[ ! -f "$icon_path" ]]; then
            echo "Icon file not found"
            return 1
          fi

          local ft
          ft="$(file -b "$icon_path" | tr '[:upper:]' '[:lower:]')"

          case "$icon_path" in
            *.png)
              [[ "$ft" == *png* ]] || { echo "Icon is not a PNG file: $ft"; return 1; }
              ;;
            *.svg)
              [[ "$ft" == *svg* ]] || { echo "Icon is not an SVG file: $ft"; return 1; }
              ;;
            *.jpg|*.jpeg)
              [[ "$ft" == *jpeg* ]] || { echo "Icon is not a JPEG file: $ft"; return 1; }
              ;;
            *)
              echo "Icon has unsupported extension (expected .png/.svg/.jpg/.jpeg)"
              return 1
              ;;
          esac

          echo "Valid icon"
        }

        template_package="$(get_rc_value "$TEMPLATE_RC" Package)"
        template_version="$(get_rc_value "$TEMPLATE_RC" Version)"
        template_description="$(get_rc_value "$TEMPLATE_RC" Description)"
        template_addon_show_name="$(get_rc_value "$TEMPLATE_RC" AddonShowName)"

        validation_results_file="validation_results.json"
        auto_updateable_apps=()

        total_packages=0
        template_packages=0
        valid_packages=0
        invalid_packages=0

        {
          echo '{'
          echo '  "validation_results": ['
        } > "$validation_results_file"

        first_result=1

        for app_dir in apps/*; do
          [[ -d "$app_dir" ]] || continue

          app_name="$(basename "$app_dir")"
          if [[ "$app_name" == "template" ]]; then
            continue
          fi

          apkg_rc="$app_dir/apkg.rc"
          total_packages=$((total_packages + 1))

          issues=()
          is_template=false

          if [[ ! -f "$apkg_rc" ]]; then
            issues+=("No apkg.rc file found")
            status="fail"
            message="${issues[0]}"
            version=""
            description=""
          else
            package="$(get_rc_value "$apkg_rc" Package)"
            version="$(get_rc_value "$apkg_rc" Version)"
            homepage="$(get_rc_value "$apkg_rc" Homepage)"
            description="$(get_rc_value "$apkg_rc" Description)"
            icon="$(get_rc_value "$apkg_rc" Icon)"
            addon_show_name="$(get_rc_value "$apkg_rc" AddonShowName)"
            index_page="$(get_rc_value "$apkg_rc" AddonIndexPage)"

            if [[ -z "$package" ]]; then
              issues+=("Package field is empty")
            elif [[ "$package" == "$template_package" ]]; then
              issues+=("Package is template default")
              is_template=true
            elif [[ "$package" != "$app_name" ]]; then
              issues+=("Package field ($package) does not match directory name ($app_name)")
            fi

            if [[ -z "$version" ]]; then
              issues+=("Version field is empty")
            elif [[ "$version" == "$template_version" ]]; then
              issues+=("Version is template default")
              is_template=true
            fi

            if [[ -z "$description" ]]; then
              issues+=("Description field is empty")
            elif [[ "$description" == "$template_description" ]]; then
              issues+=("Description is template default")
              is_template=true
            fi

            if [[ -n "$addon_show_name" && "$addon_show_name" == "$template_addon_show_name" ]]; then
              issues+=("AddonShowName is template default")
              is_template=true
            fi

            if [[ -z "$homepage" ]]; then
              issues+=("Homepage field is empty")
            fi

            if [[ -z "$icon" ]]; then
              issues+=("Icon field is empty")
            else
              if icon_path="$(find_icon "$app_dir" "$icon")"; then
                if ! icon_message="$(validate_icon_file "$icon_path")"; then
                  issues+=("Icon validation failed: $icon_message")
                fi
              else
                issues+=("Icon file not found for Icon=$icon")
              fi
            fi

            if [[ -n "$index_page" ]]; then
              if [[ ! -f "$app_dir/web/$index_page" && ! -f "$app_dir/$index_page" ]]; then
                issues+=("AddonIndexPage not found: $index_page")
              fi
            fi

            if (( ${#issues[@]} )); then
              status="fail"
              message="$(IFS='; '; echo "${issues[*]}")"
            else
              status="pass"
              message="All validation checks passed"
            fi
          fi

          if [[ "$is_template" == "true" ]]; then
            template_packages=$((template_packages + 1))
          fi

          if [[ "$status" == "pass" ]]; then
            valid_packages=$((valid_packages + 1))
            if [[ "$is_template" != "true" ]]; then
              auto_updateable_apps+=("$app_name")
            fi
          else
            invalid_packages=$((invalid_packages + 1))
          fi

          obj="{\"package\":\"$(json_escape "$app_name")\",\"status\":\"$(json_escape "$status")\",\"message\":\"$(json_escape "$message")\",\"is_template\":$is_template,\"version\":\"$(json_escape "${version:-}")\",\"description\":\"$(json_escape "${description:-}")\"}"

          if (( first_result )); then
            printf '    %s\n' "$obj" >> "$validation_results_file"
            first_result=0
          else
            printf '    ,%s\n' "$obj" >> "$validation_results_file"
          fi
        done

        {
          echo '  ],'
          echo '  "auto_updateable_apps": ['
        } >> "$validation_results_file"

        first_app=1
        for app in "${auto_updateable_apps[@]}"; do
          if (( first_app )); then
            printf '    "%s"\n' "$(json_escape "$app")" >> "$validation_results_file"
            first_app=0
          else
            printf '    ,"%s"\n' "$(json_escape "$app")" >> "$validation_results_file"
          fi
        done

        {
          echo '  ],'
          echo "  \"total_packages\": $total_packages,"
          echo "  \"template_packages\": $template_packages,"
          echo "  \"valid_packages\": $valid_packages,"
          echo "  \"invalid_packages\": $invalid_packages"
          echo '}'
        } >> "$validation_results_file"

        auto_updateable_apps_str=""
        if (( ${#auto_updateable_apps[@]} )); then
          auto_updateable_apps_str="${auto_updateable_apps[*]}"
        fi

        echo "Package validation completed:"
        echo "- Total packages: $total_packages"
        echo "- Template packages: $template_packages"
        echo "- Valid packages: $valid_packages"
        echo "- Invalid packages: $invalid_packages"
        echo "- Auto-updateable apps: ${#auto_updateable_apps[@]}"
        echo "Auto-updateable apps: $auto_updateable_apps_str"

        {
          echo "valid_packages=$valid_packages"
          echo "invalid_packages=$invalid_packages"
          echo "auto_updateable_apps=$auto_updateable_apps_str"
        } >> "$GITHUB_OUTPUT"

    - name: Generate PR comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Read validation results
          const results = JSON.parse(fs.readFileSync('validation_results.json', 'utf8'));
          
          // Generate markdown report
          let comment = `# Package Validation Report\n\n`;
          comment += `**Summary:**\n`;
          comment += `- Total packages: ${results.total_packages}\n`;
          comment += `- Valid packages: ${results.valid_packages}\n`;
          comment += `- Invalid packages: ${results.invalid_packages}\n`;
          comment += `- Template packages: ${results.template_packages}\n`;
          comment += `- Auto-updateable apps: ${results.auto_updateable_apps.length}\n\n`;
          
          comment += `**Auto-updateable Applications:**\n`;
          if (results.auto_updateable_apps.length > 0) {
            results.auto_updateable_apps.forEach(app => {
              comment += `- ${app}\n`;
            });
          } else {
            comment += `- None detected\n`;
          }
          comment += `\n`;
          
          comment += `**Detailed Results:**\n`;
          comment += `| Package | Status | Issues |\n`;
          comment += `|---------|--------|-------|\n`;
          
          results.validation_results.forEach(result => {
            const issues = result.message || 'None';
            comment += `| ${result.package} | ${result.status} | ${issues} |\n`;
          });
          
          // Post comment to PR
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: validation-report
        path: validation_results.json

    - name: Upload auto-updateable apps list
      uses: actions/upload-artifact@v4
      with:
        name: auto-updateable-apps
        path: |
          validation_results.json

    - name: Fail on validation errors
      if: steps.validate.outputs.invalid_packages != '0'
      run: |
        echo "Package validation failed!"
        echo "Invalid packages: ${{ steps.validate.outputs.invalid_packages }}"
        exit 1
