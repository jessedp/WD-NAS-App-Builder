name: Check Syncthing Version

on:
  schedule:
    # Run daily at 9 AM UTC (staggered from Tailscale)
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force check for new version even if one exists'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-syncthing-version:
    runs-on: ubuntu-latest
    name: Check Syncthing Version
    
    outputs:
      new_version: ${{ steps.compare.outputs.new_version }}
      version_changed: ${{ steps.compare.outputs.version_changed }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch latest Syncthing version from GitHub
      id: fetch_latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Fetching latest Syncthing version from GitHub API..."
        
        # Get latest release from syncthing/syncthing
        RESPONSE=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/syncthing/syncthing/releases/latest")
        
        if [ -z "$RESPONSE" ]; then
          echo "ERROR: Failed to fetch Syncthing releases"
          exit 1
        fi
        
        # Extract version from response
        LATEST_VERSION=$(echo "$RESPONSE" | grep -oP '"tag_name":\s*"\K[^"]+' | head -1)
        
        if [ -z "$LATEST_VERSION" ]; then
          echo "ERROR: Could not extract version from GitHub API response"
          echo "Response: $RESPONSE"
          exit 1
        fi

        # Extract html_url
        RELEASE_URL=$(echo "$RESPONSE" | grep -oP '"html_url":\s*"\K[^"]+' | head -1)
        
        # Remove 'v' prefix if present
        LATEST_VERSION=${LATEST_VERSION#v}
        
        echo "Latest Syncthing version found: $LATEST_VERSION"
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "raw_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "tag_version=v$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT

    - name: Get latest GitHub release for Syncthing
      id: get_release
      uses: actions/github-script@v7
      with:
        script: |
          // Get all releases and find the latest Syncthing release
          const { owner, repo } = context.repo;
          
          const releases = await github.rest.repos.listReleases({
            owner: owner,
            repo: repo,
            per_page: 100
          });
          
          // Find the latest release tagged as syncthing-v*
          const syncthingReleases = releases.data.filter(release => 
            release.tag_name && release.tag_name.match(/^syncthing-v[0-9]+\.[0-9]+\.[0-9]+$/)
          );
          
          if (syncthingReleases.length === 0) {
            console.log('No existing Syncthing releases found');
            return null;
          }
          
          // Sort by tag name (semantic version)
          syncthingReleases.sort((a, b) => {
            const versionA = a.tag_name.replace('syncthing-v', 'v').replace(/^v/, '');
            const versionB = b.tag_name.replace('syncthing-v', 'v').replace(/^v/, '');
            const partsA = versionA.replace(/^v/, '').split('.').map(Number);
            const partsB = versionB.replace(/^v/, '').split('.').map(Number);
            
            for (let i = 0; i < Math.max(partsA.length, partsB.length); i++) {
              const partA = partsA[i] || 0;
              const partB = partsB[i] || 0;
              if (partA !== partB) {
                return partB - partA; // Return highest version first
              }
            }
            return 0;
          });
          
          const latestRelease = syncthingReleases[0];
          console.log(`Latest Syncthing release: ${latestRelease.tag_name} (${latestRelease.name})`);
          
          // Extract version number from tag (remove 'v' prefix and 'syncthing-v' prefix)
          const version = latestRelease.tag_name.replace('syncthing-v', '').replace(/^v/, '');
          core.setOutput('current_version', version);
          core.setOutput('release_tag', latestRelease.tag_name);
          core.setOutput('release_id', latestRelease.id.toString());

    - name: Compare versions
      id: compare
      run: |
        LATEST_VERSION="${{ steps.fetch_latest.outputs.latest_version }}"
        CURRENT_VERSION="${{ steps.get_release.outputs.current_version }}"
        
        echo "Latest version from GitHub: $LATEST_VERSION"
        echo "Current version in releases: $CURRENT_VERSION"
        
        # Function to compare versions
        version_compare() {
          echo "$1" | awk -F. '{ printf("%d%03d%03d%03d\n", $1,$2,$3,$4); }'
        }
        
        LATEST_NUM=$(version_compare "$LATEST_VERSION")
        CURRENT_NUM=$(version_compare "$CURRENT_VERSION")
        
        echo "Latest version number: $LATEST_NUM"
        echo "Current version number: $CURRENT_NUM"
        
        if [ -z "$CURRENT_VERSION" ] || [ "$LATEST_NUM" -gt "$CURRENT_NUM" ]; then
          echo "âœ… New version detected: $LATEST_VERSION"
          echo "version_changed=true" >> $GITHUB_OUTPUT
          echo "new_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        else
          echo "âœ… No new version. Latest: $LATEST_VERSION, Current: $CURRENT_VERSION"
          echo "version_changed=false" >> $GITHUB_OUTPUT
          echo "new_version=" >> $GITHUB_OUTPUT
        fi

    - name: Trigger build workflow if new version
      if: steps.compare.outputs.version_changed == 'true' || github.event.inputs.force_check == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const newVersion = '${{ steps.compare.outputs.new_version }}';
          
          console.log(`Triggering build workflow for Syncthing ${newVersion}`);
          
          // Trigger the build-and-release workflow
          await github.rest.actions.createWorkflowDispatch({
            owner: owner,
            repo: repo,
            workflow_id: 'build-and-release.yml',
            ref: 'main',
            inputs: {
              package: 'syncthing',
              new_version: newVersion,
              changelog: 'Changelog not available',
              changelog_url: '${{ steps.fetch_latest.outputs.release_url }}'
            }
          });

    - name: Report status
      run: |
        if [ "${{ steps.compare.outputs.version_changed }}" == "true" ] || [ "${{ github.event.inputs.force_check }}" == "true" ]; then
          echo "ðŸš€ New Syncthing version detected: ${{ steps.compare.outputs.new_version }}"
          echo "âœ… Build workflow triggered successfully"
        else
          echo "âœ… No new Syncthing version found"
          echo "ðŸ“Š Latest: ${{ steps.fetch_latest.outputs.latest_version }} | Current: ${{ steps.get_release.outputs.current_version }}"
        fi